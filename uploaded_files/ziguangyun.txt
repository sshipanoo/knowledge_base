紫光云系列问题及解决方案（更新中）
此文档持续更新中，完成后标题会显示终版。

unicloud 旧插件升级新插件的步骤。
0. 先登出所有iscsi session                     iscsi -m node -U all 
1. 把之前的iscsi的服务stop                    systemctl stop iscsid
2. 清理之前的缓存 ,这个根据代理的版本不同，执行的命令不一样。也可以4个命令全部执行一遍，不影响。    rm -rf /etc/iscsi/nodes  rm -rf /etc/iscsi/send_targets | rm -rf /var/lib/iscsi/nodes  rm -rf /var/lib/iscsi/nodes  
3. 重启iscsi的服务                                  systemctl start iscsid
4. 把之前的redis-cli的锁手动删除掉，直到返回的是 nil 0。
然后再用新的插件备份，应该就可以了。


接口参数相关:
1.快照创建
				
SnapshotType	快照类型	4	临时快照	
				







一、rbd相关
rbd相关的问题比较复杂，排查的时候优先检查代理上的网络，备份和代理  需要和云平台管理网、存储的管理网和存储网通，网络没有问题但是备份还是失败，再查看版本。
网络问题
如何检查网络，在代理上执行ceph命令，如果能正常进入到交互的环境中，那说明没有问题；

如果一段时间后一直卡着，ctrl+c 取消后报错连接失败等相关的信息。则说明网络有问题，再进行网络相关的排查。



版本问题
rbd分不同的版本，对应的是不同的onestor的存储版本，不同版本对客户端（代理）Python的要求不一样。
如何查看版本
在onestor存储的后台执行 cat /etc/onestor client version查看。
V后面跟的第一个数字为5的要求Python3.9.X环境，不分小版本，但是必须是Python3.9才行。

Python3.9的环境安装
1、先下载python 3.9的包， 解压后进入目录执行 ./configure --enable-optimizations 
2、在执行 make altinstall 
3、删除原来 /usr/bin/python的软链接，重新建立 ln -s /usr/local/bin/python3.9 /usr/bin/python 
4、vim /.bashrc 增加export PATH=/usr/local/bin/python3.9:$PATH ，执行source /.bashrc  
5、修改vi /etc/profile ,注释最后的#scl enable rh-python38 bash ，再执行soure /etc/profile, 退出然后重新执行python就OK了
执行rbd clone报错
执行rbd clone的时候报错librd err，错误码22.
解决办法
联系华三去查问题记录单202406261721
需要修改存储的主备节点，两个节点里都要修改（onestor的已知问题，在存储上修改，代理不用调整）。注意我们代理上不需要做任何修改，联系华三的人让他们修改存储上的配置。
具体操作
1.修改文件
vim /opt/h3c/lib/python3.9/site-packages/onestor/regexp.py

2.找到字段，修改如下
check_vaff_regexp['data_pool'] = check_regexp["PLAT_user_name_30"]  # 平台公共正则表达式
check_vaff_regexp['node_pool'] = check_regexp["PLAT_user_name_30"]

3.最后重启服务
supervisorctl restart blk-leader


执行rbd export diff 报错
具体表现为界面日志显示如下：

查看代理后台显示日志如下：

看不到再具体的信息。
解决办法
进行如下的检查：
check 1:   确定rbd 的版本，V5的进行check 2。
check 2：确保安装了python3.9.X的环境，并且是按照上述安装方式进行安装的。

对于多个存储池配置文件是uuid的情况
如果遇到onestor的存储，有多个存储池并且ceph的配置文件的名称是uuid的时候，需要先在存储的界面上确认下存储池那里的显示，如果显示的是名称，需要修改ceph的配置文件，将存储池的uuid改为对应的名称。



如果找不到名称和uuid的对应关系，可以使用F12来看存储的界面接口调用，找到对应的uuid，具体参考下图。




二、挂载磁盘相关
备份的时候快照导出正常，也返回结果正常。但是挂载磁盘重试到最大后依然没有找到。排除是iSCSI登录和锁的问题之后（以前的版本都会有这个锁的问题），应该考虑三个方面。
如何验证
1.查看代理上插件目录/opt/rongan/plugin/unicloud下的config.json的配置文件，确认sendTargets字段配置了正确的存储ip地址。
2.验证代理到存储的网络是否正常连通，并且确认端口是否正常开放。
a.使用ping 验证网络连接
b.使用nc或者telnet验证端口是否正常开放
3.检查/etc/iscsi/initiatorname.iscsi 的后缀和/opt/rongan/plugin/unicloud/agent_id这个的内容是否一致。
代理网络
排查代理到存储的网络是否是通的，有的环境中要加路由才行。
存储配置
此问题一般在xsky存储下遇到
在存储的界面看下访问路径有没有客户端与卷的映射关系。

三、虚拟机不允许操作
备份报错显示当前虚拟机正在进行，不允许处理。考虑两个方面来解决问题。
云平台配置
联系云平台的人，查看是否备份的虚拟机容量较大，平台的校验时间是否进行过修改，如果没有的话联系其进行修改，项目测试数值（7000）可以解决问题。
插件代理配置
查看插件的配置文件/opt/rongan/plugin/unicloud/config.json。
查看其中的字段  
"taskMaxRetry": 3,
"taskMaxQuery": 50,

如果显示上述默认值，对其进行调整，taskMaxRetry修改为300，taskMaxQuery 修改为72000
如果上述调整后还不能解决问题，再次调大相关数值进行尝试。
四、更新qos失败
此问题为概率性问题，一般出现在恢复的步骤中，出现后联系紫光云的人员解决。


解决办法
遇到时联系xksy存储的人解决。
五、重复卷映射问题
此问题只在恢复的时候遇到，和更新qos失败一样，都是在xsky为存储的时候遇到，表现为conflicti[http://10.29.241.41:8056/v1/mapping-groups/?cluster id=1] [Xskduring [path"PosTyClient#createMappingGroup(Long,CreateMappingGroup)]:It"msg":"Volumapped to other access path"}。


造成此问题的原因如下：
1.插件在备份时通过生成一个agent_id作为iqn的后缀名称，一般情况下这个不会改变。但是在恢复的时候由于xsky的接口不能调用第一次的unExport接口，导致恢复前取消的这个步骤无法实现。如果agent_id发生了改变，在第二次恢复的时候就会造成这个冲突的问题。这个时候只能在xsky存储上手动在存储上取消之前的映射。
2.如果agent_id没有改变，使用如下命令来查看下日志，grep -r 'CALLEXPORTFORXSKY' /opt/rongan/log/unicloud-fd.log 。看下输出的结果，正常情况下会有一个输出，如果不符合预期，联系研发查看。

解决办法
遇到时进行两个步骤，两个缺一不可：
1.联系xksy的人，确认是否已经处理过了流程，他们这边对恢复要进行特殊处理。
2.联系研发，查看是否已经去掉恢复的时调用的UnExport的接口。
六、连接数据库问题
一般项目上备份服务器有多个ip的情况下会有概率遇到。
此问题表现为备份一开始的时候界面任务日志就能看到错误，代理上插件日志显示连接数据库的信息，检查ip是否是正确的。
前期检查
确定当前的策略的id，下面的x为策略id，进行对应的替换。
登录备份服务器，查看/opt/extra/conf/server/job_x.conf文件，检查对应的host是否是正确的备份服务器的ip地址。
七、多个ceph配置
rbd export-diff命令返回了 (2) No such file or directory 错误

1. 镜像名称错误：你指定的 RBD 镜像名称 `sys-j7sle9gvpno6` 可能不存在，或者拼写有误。你可以使用 `rbd ls` 命令列出池中的所有镜像，确认镜像是否存在。

   
  rbd -c /etc/onestor_client/diskpool01.conf --keyring /etc/onestor_client/diskpool01.keyring ls diskpool01


   检查输出中是否有 `sys-j7sle9gvpno6` 这个镜像。如果没有这个名称的镜像，那么需要确认你是否使用了正确的名称。

2. 快照不存在：你在命令中指定了快照 `@runstor-test`，这意味着你正在尝试导出镜像 `sys-j7sle9gvpno6` 的 `runstor-test` 快照。需要确认这个快照是否存在。

   你可以列出镜像的所有快照，确认 `runstor-test` 是否存在：
 rbd -c /etc/onestor_client/diskpool01.conf --keyring /etc/onestor_client/diskpool01.keyring snap ls diskpool01/sys-j7sle9gvpno6


   如果没有找到这个快照，说明你可能使用了错误的快照名称，或者快照还没有创建。

3. Ceph 集群连接问题：在 `rbd` 命令中你指定了 `--conf` 和 `--keyring` 参数，这意味着你在使用特定的 Ceph 配置文件和密钥环。确保这些文件的路径是正确的，并且 Ceph 集群是可访问的。

●   检查 `/etc/onestor_client/diskpool01.conf` 是否正确配置了集群的 monitor 地址、池信息等。
●    检查 `/etc/onestor_client/diskpool01.keyring` 是否包含有效的密钥，确保你有足够的权限访问指定的池和镜像。

4. 池名称问题：你可能没有明确指定池名称，而是依赖默认池。如果你没有明确指定池名，Ceph 会使用默认池。你可以显式地指定池名称，确保访问的是正确的池。

   改进后的命令如下：
 rbd -c /etc/onestor_client/diskpool01.conf --keyring /etc/onestor_client/diskpool01.keyring export-diff diskpool01/sys-j7sle9gvpno6@runstor-test -


   这里明确指定了池 `diskpool01`，避免使用默认池。

5. 文件系统权限或路径问题：确保 /etc/onestor_client/diskpool01.conf和 /etc/onestor_client/diskpool01.keyring文件的权限设置正确，并且可以被当前执行命令的用户读取。

总结：
你可以按照以下步骤来排查问题：
1. 使用 `rbd ls` 确认镜像 `sys-j7sle9gvpno6` 是否存在。
2. 使用 `rbd snap ls` 确认快照 `runstor-test` 是否存在。
3. 检查配置文件和密钥环的路径是否正确。
4. 确保 Ceph 集群处于正常状态，并且可以访问。
解决办法
联系研发针对这个项目单独适配。
八、多个存储池的备份(by 陈少华) 【后续整理】
情景一：多个存储池，存储池名称不同
        有多个存储池。但是存储池名称不同，可以根据存储池的名称来命名ceph的配置文件，如：diskpool01.conf、diskpool02.conf。



情景二：多个存储池，存储池名称相同
        有多个存储池，但是存储池名称相同。可以根据存储池的数量，新建代理虚机，不同的代理虚机备份不同的存储池上的虚机资源。
        ceph配置文件名称按照存储池名称命名，如：diskpool01.conf。
（有多个存储池，但是存储池名称不同亦可使用情景二的方式进行备份，但考虑到客户的虚机资源，优先考虑情景一方式）

九、云魔方在编辑对象存储的介质后备份失败
前端问题，编辑后数据的类型发生改变。插件上可以做如下修改解决。
到/opt/rongan/plugin/unicloud/lib目录下。编辑oss.py文件，第32上，如下所示加上int即可。

十、云魔方下发策略不使用默认客户端
若代理虚拟机不是备份系统本身，则需注释\opt\studio\backend\app\app\api\api_v1\endpoints\api backup\unicloud.py文件如图所示的两行，修改后重启rongan-studio服务，后续下发策略时将不会在使用默认客户端。

十一、添加扩展服务时提示“该服务编码已存在”
在unicloud7.0版本中存在重新部署云服务功能，在新建扩展服务时可能会遇到该问题

需要在运管平台中的点击云运营-云服务目录

然后在之前设置备份服务的功能栏中删除该服务，最后进行发布即可删除之前创建的服务编码


